#!/bin/bash


#Current connection
net=$(nmcli --field "Name" connection show --active | grep -v "^lo[[:space:]]" | sed '1d')
if [ "$net" = "" ]; then
  net="None"
fi

#is wifi enabled
state=$(nmcli radio wifi)
if [ $state = "enabled" ]; then
  opt="---DISABLE Wi-Fi---"
else
  opt="---ENABLE Wi-Fi---"
fi

#list of all scaned wifi
wifi_list=$(nmcli --field "BARS,SECURITY,SSID" device wifi list | sed 1d | sort -k3,3 -u | sort -r -k1,1 | sed -E "s/WPA*.?\S/  /g" | sed "s/802\.1X//g" | sed "s/ \+//g" | sed "s/   \+/  /g" | grep -v " -- *$") 
wifi_list_opt="$wifi_list\n$opt\n---RESCAN---"

#rofi menu to chose net
chosen_net=$(echo -e "$wifi_list_opt" | rofi -dmenu -p $net)
chosen_name=$(echo "${chosen_net:9}" | sed "s/ //g")
if [ "$chosen_net" = "" ]; then
  exit
elif [ "$chosen_net" = "---DISABLE Wi-Fi---" ]; then
  nmcli radio wifi off
  notify-send "Wi-Fi Disabled"
elif [ "$chosen_net" = "---ENABLE Wi-Fi---" ]; then 
  nmcli radio wifi on
  notify-send "Starting Wi-Fi..."
  sleep 3
  ./wifimenu
elif [ "$chosen_net" = "---RESCAN---" ]; then
  notify-send "Rescaning..."
  nmcli device wifi rescan
  sleep 3
  ./wifimenu
else
  #list of all saved networks
  saved_net=$(nmcli -g NAME connection)
  #information about chosen net
  net_info=$(nmcli --field ssid,rate,signal,security device wifi list | grep -m 1 $chosen_name | awk '{print "name:",$1, "\nrate:",$2,$3, "\nsignal:",$4,"%", "\nsecurity:",$5,$6,$7}' | uniq -u)
  #options if chosen net is already saved
  if [[ "$saved_net" =~ "$chosen_name" ]]; then
    net_info="$net_info\n---CONNECT---\n---DELETE---"
  else
    net_info="$net_info\n---ENTER PASSWORD---"
  fi
  
  #chose option(connect/delete)
  option=$(echo -e "$net_info" | rofi -dmenu)
  
  case "$option" in

    "---CONNECT---")
      notify-send "Connecting..."
      nmcli device wifi connect $chosen_name
      notify-send "Wi-Fi connected"
      ;;
    
    "---DELETE---")
      nmcli connection delete $chosen_name
      notify-send "Connection deleted"  
    ;;

    "---ENTER PASSWORD---")
      while true; do
        password=$(rofi -dmenu -password -p "Enter password:")
        if [ -z "$password" ]; then
          notify-send "Connection canceled"
          exit
        fi
        if echo $password | nmcli device wifi connect $chosen_name --ask; then
          notify-send "✅ Connected to $chosen_name"
          exit
        else
          notify-send "Wi-Fi" "❌ Wrong password. Try again."
          nmcli connection delete "$chosen_name" >> /dev/null
        fi
      done
    esac
fi 
